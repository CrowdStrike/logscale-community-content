```
/*
The following query looks for Falcon Sensor for Windows versions that need
to be hotfixed or updated to address CVE-2025-42701 and CVE-2025-42706.
The datasource for this query is the AID Master lookup file. That file
is automatically updated every few hours.
*/

// Restrict search to Windows systems in AID Master
| readFile([aid_master_main.csv])
| event_platform=Win
 
// Parse AgentVersion into individual components for evaluation
| AgentVersion=/^(?<majorVersion>\d+)\.(?<minorVersion>\d+)\.(?<buildNumber>\d+)\./

// Check for updated version
| case {
      // Handles 8+
      majorVersion>7                                    | Status:="OK";
      // Handles 7.29+
      majorVersion=7 minorVersion>28                    | Status:="OK";
      // Handles 7.28
      majorVersion=7 minorVersion=28 buildNumber<=20006 | Status:="HOTFIX AVAILABLE";
      majorVersion=7 minorVersion=28 buildNumber>=20008 | Status:="OK";
      // Handles 7.27
      majorVersion=7 minorVersion=27 buildNumber<=19907 | Status:="HOTFIX AVAILABLE";
      majorVersion=7 minorVersion=27 buildNumber>=19909 | Status:="OK";
      // Handles 7.26
      majorVersion=7 minorVersion=26 buildNumber<=19811 | Status:="HOTFIX AVAILABLE";
      majorVersion=7 minorVersion=26 buildNumber>=19813 | Status:="OK";
      // Hanldes 7.25
      majorVersion=7 minorVersion=25 buildNumber<=19706 | Status:="HOTFIX AVAILABLE";
      majorVersion=7 minorVersion=25 buildNumber>=19707 | Status:="OK";
      // Handles 7.24
      majorVersion=7 minorVersion=24 buildNumber<=19607 | Status:="HOTFIX AVAILABLE";
      majorVersion=7 minorVersion=24 buildNumber>=19600 | Status:="OK";
      // Handles 7.16 Windows 7
      majorVersion=7 minorVersion=16 buildNumber<=19635 | Status:="HOTFIX AVAILABLE";
      majorVersion=7 minorVersion=16 buildNumber>=19637 | Status:="OK";
      // Handles all other 7 versions
      majorVersion=7 minorVersion<24  | Status:="OUT OF SUPPORT - UPDATE SENSOR";
      // Handles all other versions
      majorVersion<7                  | Status:="OUT OF SUPPORT - UPDATE SENSOR";
      // Catch all for logic errors
	  * | Status:="UNKNOWN";         
}

// Modify field names for easier reading
| rename([[cid, "Customer ID"],[aid, "Agent ID"], [event_platform, Platform], [aip, "External IP"]])

// Aggregate results into tabular format with cleaner ordering
| groupBy(["Customer ID", "Agent ID", ComputerName, Platform, Version, AgentVersion, Status, "External IP", LocalAddressIP4, MAC, SystemManufacturer, SystemProductName, FirstSeen, Time], function=[], limit=max)
 
// Set default values for easier reading
| default(value="-", field=[ComputerName, Version, AgentVersion, Status, LocalAddressIP4, MAC, SystemManufacturer, SystemProductName, FirstSeen, Time], replaceEmpty=true)
 
// Move timestamps from epoch to human readable
| formatTime(format="%F %T", as="FirstSeen", field=FirstSeen)
| formatTime(format="%F %T", as="LastSeen", field=Time) 

// Remove unnecessary field
| drop([Time])

```