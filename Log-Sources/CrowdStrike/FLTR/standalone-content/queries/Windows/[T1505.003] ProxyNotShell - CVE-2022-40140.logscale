// [T1505.003] ProxyNotShell - CVE-2022-40140

// Reference: https://www.reddit.com/r/crowdstrike/comments/xsvyn4/situational_awareness_proxynotshell_cve202240140/

// Select one of the two queries. 

#event_simpleName=ProcessRollup2 
| event_platform=Win ImageFileName=/\\w3wp\.exe$/i
| CommandLine=/\&(ipconfig|quser|whoami|c\:|cd|dir|echo)/i
| select([cid, aid, TargetProcessId, ParentBaseFileName, ImageFileName, CommandLine])
| "Process Explorer" := format("[Process Explorer](https://falcon.crowdstrike.com/investigate/process-explorer/%s/%s)", field=["aid", "TargetProcessId"])

#event_simpleName=ProcessRollup2 
| ImageFileName=/msexchange/i
| join({#event_simpleName=NewScriptWritten TargetFilename=/FrontEnd\\HttpProxy\\/i}, key=[aid, ContextProcessId], field=[aid, TargetProcessId], include=[TargetFileName])
| select([cid, aid, TargetProcessId, ParentBaseFileName, ImageFileName, CommandLine, TargetFileName])
| "Process Explorer" := format("[Process Explorer](https://falcon.crowdstrike.com/investigate/process-explorer/%s/%s)", field=["aid", "TargetProcessId"])
